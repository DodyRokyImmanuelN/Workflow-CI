name: MLflow Project Training - Heart Disease (ADVANCED)

# ===== TRIGGER =====
on:
  # Manual trigger
  workflow_dispatch:

  # Trigger saat push ke main
  push:
    branches:
      - main
    paths:
      - "MLProject/**"
      - ".github/workflows/mlflow-training.yml"

  # Scheduled trigger (setiap hari jam 12:00 UTC)
  schedule:
    - cron: "0 12 * * *"

# ===== PERMISSIONS =====
permissions:
  contents: write
  actions: read
  packages: write

# ===== JOBS =====
jobs:
  mlflow-training:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Setup Python
      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow scikit-learn pandas numpy matplotlib seaborn
          echo "âœ… Dependencies installed"

      # Step 4: Setup MLflow tracking directories
      - name: Setup MLflow tracking
        run: |
          mkdir -p mlruns
          mkdir -p artifacts
          echo "âœ… Directories created"

      # Step 5: Prepare dataset for MLProject
      - name: Prepare dataset
        run: |
          # Copy preprocessed dataset to MLProject folder
          if [ -f "preprocessing/heart_preprocessing.csv" ]; then
            cp preprocessing/heart_preprocessing.csv MLProject/
            echo "âœ… Dataset copied to MLProject/"
          elif [ -f "heart_preprocessing.csv" ]; then
            cp heart_preprocessing.csv MLProject/
            echo "âœ… Dataset copied to MLProject/"
          else
            echo "âš ï¸ Warning: Preprocessed dataset not found"
            echo "   Workflow will proceed but may fail during training"
          fi

      # Step 6: Run MLflow Project (RETRAINING)
      - name: Run MLflow Project - Model Retraining
        run: |
          export MLFLOW_TRACKING_URI="file://$(pwd)/mlruns"
          echo "ðŸš€ Starting MLflow Project retraining..."
          
          # Jalankan MLflow Project (bukan python script manual)
          mlflow run MLProject/ \
            --env-manager local \
            --experiment-name "HeartDisease_Classification_MLProject"
          
          echo "âœ… MLflow Project retraining completed"

      # Step 7: Get latest MLflow run ID
      - name: Get latest MLflow run ID
        id: get_run_id
        run: |
          export MLFLOW_TRACKING_URI="file://$(pwd)/mlruns"
          
          # Query MLflow untuk mendapatkan run ID terbaru
          RUN_ID=$(python -c "
import mlflow
client = mlflow.tracking.MlflowClient()
experiment = client.get_experiment_by_name('HeartDisease_Classification_MLProject')
if experiment is None:
    raise Exception('Experiment not found')
runs = client.search_runs(experiment.experiment_id, order_by=['start_time DESC'], max_results=1)
if len(runs) == 0:
    raise Exception('No runs found')
print(runs[0].info.run_id)
")
          
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "âœ… Latest MLflow Run ID: $RUN_ID"

      # Step 8: Get model metrics from MLflow
      - name: Get model metrics
        id: get_metrics
        run: |
          export MLFLOW_TRACKING_URI="file://$(pwd)/mlruns"
          
          # Ambil metrics dari MLflow run
          python -c "
import mlflow
client = mlflow.tracking.MlflowClient()
run = client.get_run('${{ steps.get_run_id.outputs.run_id }}')
metrics = run.data.metrics

print('ðŸ“Š Model Metrics:')
for key, value in metrics.items():
    print(f'{key}: {value:.4f}')
    
# Save metrics untuk summary
with open('metrics.txt', 'w') as f:
    for key, value in metrics.items():
        f.write(f'{key}={value:.4f}\n')
"
          echo "âœ… Metrics retrieved from MLflow"

      # Step 9: Collect artifacts from MLflow
      - name: Collect artifacts from MLflow
        run: |
          echo "ðŸ“¦ Collecting artifacts from MLflow run..."
          export MLFLOW_TRACKING_URI="file://$(pwd)/mlruns"
          
          # Copy seluruh mlruns directory
          if [ -d "mlruns" ]; then
            cp -r mlruns artifacts/
            echo "âœ… MLflow runs copied to artifacts/"
          fi
          
          # Download artifacts dari MLflow run ke artifacts folder
          python -c "
import mlflow
import shutil
import os

client = mlflow.tracking.MlflowClient()
run_id = '${{ steps.get_run_id.outputs.run_id }}'

# Download semua artifacts dari run
artifacts_path = client.download_artifacts(run_id, '', dst_path='./downloaded_artifacts')
print(f'âœ… Artifacts downloaded to: {artifacts_path}')

# Copy ke artifacts folder
if os.path.exists(artifacts_path):
    for item in os.listdir(artifacts_path):
        src = os.path.join(artifacts_path, item)
        dst = os.path.join('artifacts', item)
        if os.path.isfile(src):
            shutil.copy2(src, dst)
        elif os.path.isdir(src):
            shutil.copytree(src, dst, dirs_exist_ok=True)
    print('âœ… Artifacts copied to artifacts folder')
"
          
          # List all artifacts
          echo "ðŸ“‹ Artifacts collected:"
          find artifacts/ -type f 2>/dev/null || echo "No artifacts found"

      # Step 10: Upload artifacts to GitHub
      - name: Upload artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-training-artifacts-${{ github.sha }}
          path: |
            artifacts/
            mlruns/
          retention-days: 30

      # Step 11: Commit artifacts to repository
      - name: Commit artifacts to repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

          # Add artifacts
          git add artifacts/ mlruns/ || true

          if git diff --staged --quiet; then
            echo "â­ï¸ No changes to commit"
          else
            git commit -m "ðŸ¤– Auto: MLflow retraining artifacts [Run: ${{ steps.get_run_id.outputs.run_id }}] - $(date +'%Y-%m-%d %H:%M:%S')" || echo "âš ï¸ Commit skipped"
            git push origin main || echo "âš ï¸ Push skipped"
          fi

      # Step 12: Job Summary
      - name: Job Summary
        run: |
          echo "## âœ… MLflow Project Retraining Complete - ADVANCED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Project**: Heart Disease Classification" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Level**: ADVANCED (4 pts)" >> $GITHUB_STEP_SUMMARY
          echo "**â° Timestamp**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”— MLflow Run ID**: \`${{ steps.get_run_id.outputs.run_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“¦ Commit SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add metrics to summary
          echo "### ðŸ“Š Model Performance Metrics" >> $GITHUB_STEP_SUMMARY
          if [ -f "metrics.txt" ]; then
            while IFS='=' read -r key value; do
              echo "- **${key}**: ${value}" >> $GITHUB_STEP_SUMMARY
            done < metrics.txt
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âœ… Completed Tasks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Model Retraining via MLflow Project" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Artifacts Saved to GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Model Metrics Logged to MLflow" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Visualizations Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Generated Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trained Model (heart_disease_model.pkl)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Confusion Matrix (heart_confusion_matrix.png)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Feature Importance (heart_feature_importance.png)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Classification Report (heart_classification_report.txt)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… MLflow Tracking Data (mlruns/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts are available for download in the Actions tab:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Actions** tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Select this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "3. Scroll down to **Artifacts** section" >> $GITHUB_STEP_SUMMARY
          echo "4. Download: \`mlflow-training-artifacts-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ“ Kriteria Advanced Terpenuhi" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **MLflow Project untuk retraining** (bukan manual python script)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Workflow CI dengan GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Artifacts tersimpan di GitHub repository" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… MLflow experiment tracking terintegrasi" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Automatic artifact collection dari MLflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Retraining Method" >> $GITHUB_STEP_SUMMARY
          echo "Model di-retrain menggunakan **\`mlflow run\`** command yang menjalankan MLProject," >> $GITHUB_STEP_SUMMARY
          echo "bukan dengan menjalankan file Python secara manual." >> $GITHUB_STEP_SUMMARY