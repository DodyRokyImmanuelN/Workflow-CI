name: MLflow Project Training - Heart Disease

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "ML-Project/**"
      - ".github/workflows/mlflow-training.yml"
  schedule:
    - cron: "0 12 * * *"

permissions:
  contents: write
  actions: read

jobs:
  mlflow-training:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Setup Miniconda
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          activate-environment: base
          auto-activate-base: true

      # 3ï¸âƒ£ Install MLflow (bootstrap only)
      - name: Install MLflow
        run: |
          pip install mlflow==2.8.0
          mlflow --version

      # 4ï¸âƒ£ Prepare MLflow directories
      - name: Setup MLflow tracking
        run: |
          mkdir -p mlruns artifacts

      # 5ï¸âƒ£ Prepare dataset
      - name: Prepare dataset
        run: |
          if [ -f "preprocessing/heart_preprocessing.csv" ]; then
            cp preprocessing/heart_preprocessing.csv ML-Project/
          elif [ -f "heart_preprocessing.csv" ]; then
            cp heart_preprocessing.csv ML-Project/
          else
            echo "âš ï¸ Dataset not found"
          fi

      # 6ï¸âƒ£ Run MLflow Project (INI INTINYA)
      - name: Run MLflow Project
        run: |
          export MLFLOW_TRACKING_URI="file://$(pwd)/mlruns"
          mlflow run ML-Project \
            --experiment-name HeartDisease_Classification_ML-Project

      # 7ï¸âƒ£ Collect artifacts
      - name: Collect artifacts
        run: |
          cp -r mlruns artifacts/ || true
          cp -r ML-Project/artifacts/* artifacts/ 2>/dev/null || true
          find artifacts -type f

      # 8ï¸âƒ£ Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-artifacts-${{ github.sha }}
          path: |
            artifacts/
            mlruns/
          retention-days: 30

      # 9ï¸âƒ£ Commit artifacts (opsional tapi ADVANCED)
      - name: Commit artifacts
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"
          git add artifacts mlruns || true
          git commit -m "ðŸ¤– Auto MLflow artifacts - ${{ github.sha }}" || echo "No changes"
          git push || echo "Push skipped"

      # ðŸ”Ÿ Summary
      - name: Job Summary
        run: |
          echo "## âœ… MLflow Project Training Complete (ADVANCED)" >> $GITHUB_STEP_SUMMARY
          echo "- MLflow Project: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Conda Environment: âœ… (conda.yaml)" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts saved: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- CI Automation: âœ…" >> $GITHUB_STEP_SUMMARY
